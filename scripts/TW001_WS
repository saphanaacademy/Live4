-- run this as LIVE4 user

CREATE COLUMN TABLE LIVE4.T001W_WS (  
	 ROWNUM INTEGER,
	 MANDT VARCHAR(3),
	 WERKS VARCHAR(4),
	 NAME1 VARCHAR(30),
	 NAME2 VARCHAR(30),
	 STRAS VARCHAR(35),
	 ORT01 VARCHAR(25),
	 REGIO VARCHAR(3),
	 LAND1 VARCHAR(3),
	 PSTLZ VARCHAR(10),
	 STR_LONGITUDE DOUBLE,
	 STR_LATITUDE DOUBLE,
	 AQI INTEGER,
	 TMP INTEGER,
	 HUM INTEGER,
	 WS_AQI_SITENUM INTEGER,
	 WS_AQI_LONGITUDE DOUBLE,
	 WS_AQI_LATITUDE DOUBLE,
	 WS_AQI_DISTANCE DOUBLE,
	 WS_TMP_SITENUM INTEGER,
	 WS_TMP_LONGITUDE DOUBLE,
	 WS_TMP_LATITUDE DOUBLE,
	 WS_TMP_DISTANCE DOUBLE,
	 WS_HUM_SITENUM INTEGER,
	 WS_HUM_LONGITUDE DOUBLE,
	 WS_HUM_LATITUDE DOUBLE,
	 WS_HUM_DISTANCE DOUBLE,
	 AQI_O INTEGER,
	 TMP_O INTEGER,
	 HUM_O INTEGER,
	 PRIMARY KEY ("ROWNUM")
	) UNLOAD PRIORITY 5 AUTO MERGE;

INSERT INTO LIVE4.T001W_WS 
	SELECT 
	 ROW_NUMBER() over (ORDER BY QAQI.MANDT, QAQI.WERKS ASC) AS ROWNUM,
 	 QAQI.MANDT, QAQI.WERKS, QAQI.NAME1, QAQI.NAME2, QAQI.STRAS, QAQI.ORT01, QAQI.REGIO, QAQI.LAND1, QAQI.PSTLZ,
 	 QAQI.LON_STR, QAQI.LAT_STR, 
 	 QAQI.AQI, QTMP.TMP, QHUM.HUM, 
	 QAQI.SITENUM_AQI, QAQI.LON_AQI, QAQI.LAT_AQI, QAQI.DIST_AQI,
	 QTMP.SITENUM_TMP, QTMP.LON_TMP, QTMP.LAT_TMP, QTMP.DIST_TMP,
	 QHUM.SITENUM_HUM, QHUM.LON_HUM, QHUM.LAT_HUM, QHUM.DIST_HUM,
	 QAQI.AQI, QTMP.TMP, QHUM.HUM
	FROM
	(
		SELECT DISTINCT
		 TW.MANDT, 
		 TW.WERKS, 
		 TW.NAME1,
		 TW.NAME2,
		 TW.STRAS,
		 TW.ORT01,
		 TW.REGIO,
		 TW.LAND1,
		 TW.PSTLZ, 
		 SP.POSTCODE, 
		 SP.SHAPE.ST_X() AS LON_STR,
		 SP.SHAPE.ST_Y() AS LAT_STR,
		 DL."aqi" AS AQI,
		 DL."longitude" AS LON_AQI,
		 DL."latitude" AS LAT_AQI,
		 NEW ST_Point( DL."longitude",  DL."latitude").ST_Distance(SP.SHAPE) AS DIST_AQI,	
		 ROW_NUMBER() over (PARTITION BY TW.WERKS ORDER BY NEW ST_Point( DL."longitude",  DL."latitude").ST_Distance(SP.SHAPE) ASC, TO_NUMBER(DL."aqi") DESC) AS ROWNUM,
		 10000000 * DL."state_code" + 10000 * DL."county_code" + DL."site_num" AS SITENUM_AQI
		FROM 
		 LIVE4.T001W TW,
		 SAP_SPATIAL_POSTAL.USA_2014Q2_PCB_PTS_UNGEN_C SP,
		 LIVE4."DataLake_AQI" DL
		WHERE 
		 SP.POSTCODE = TW.PSTLZ AND
		 SP.ADMIN2 = UPPER(DL."state_name")
		ORDER BY 
		 ROWNUM
	) AS QAQI,
	(
		SELECT DISTINCT
		 TW.WERKS, 
		 DL."1st_max_value" AS TMP,
		 DL."longitude" AS LON_TMP,
		 DL."latitude" AS LAT_TMP,
	 	 NEW ST_Point( DL."longitude",  DL."latitude").ST_Distance(SP.SHAPE) AS DIST_TMP,	
	 	 ROW_NUMBER() over (PARTITION BY TW.WERKS ORDER BY NEW ST_Point( DL."longitude",  DL."latitude").ST_Distance(SP.SHAPE) ASC, TO_NUMBER(DL."1st_max_value") DESC) AS ROWNUM,
	 	 10000000 * DL."state_code" + 10000 * DL."county_code" + DL."site_num" AS SITENUM_TMP
		FROM 
		 LIVE4.T001W TW,
		 SAP_SPATIAL_POSTAL.USA_2014Q2_PCB_PTS_UNGEN_C SP,
		 LIVE4."DataLake_Temperature" DL
		WHERE 
		 SP.POSTCODE = TW.PSTLZ AND
		 SP.ADMIN2 = UPPER(DL."state_name")
	) AS QTMP,
	(
		SELECT DISTINCT
		 TW.WERKS, 
		 DL."1st_max_value" AS HUM,
		 DL."longitude" AS LON_HUM,
		 DL."latitude" AS LAT_HUM,
	 	 NEW ST_Point( DL."longitude",  DL."latitude").ST_Distance(SP.SHAPE) AS DIST_HUM,	
	 	 ROW_NUMBER() over (PARTITION BY TW.WERKS ORDER BY NEW ST_Point( DL."longitude",  DL."latitude").ST_Distance(SP.SHAPE) ASC, TO_NUMBER(DL."1st_max_value") DESC) AS ROWNUM,
	 	 10000000 * DL."state_code" + 10000 * DL."county_code" + DL."site_num" AS SITENUM_HUM
		FROM 
		 LIVE4.T001W TW,
		 SAP_SPATIAL_POSTAL.USA_2014Q2_PCB_PTS_UNGEN_C SP,
		 LIVE4."DataLake_Humidity" DL
		WHERE 
		 SP.POSTCODE = TW.PSTLZ AND
		 SP.ADMIN2 = UPPER(DL."state_name")
	) AS QHUM
	WHERE 
	 QAQI.ROWNUM = 1 AND 
	 QTMP.ROWNUM = 1 AND
	 QHUM.ROWNUM = 1 AND
	 QAQI.WERKS = QTMP.WERKS AND
	 QAQI.WERKS = QHUM.WERKS
	ORDER BY
	 QAQI.WERKS;

SELECT * FROM LIVE4.T001W_WS;
